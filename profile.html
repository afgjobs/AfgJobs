<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#2563eb" />
  <title>My Profile - AfgJobs</title>
  <meta name="description" content="View and manage your AfgJobs profile, job postings, and account settings.">
  <link rel="icon" href="logo.png" type="image/x-icon">
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/logo.png">
  <link rel="canonical" href="https://afgjobs.com/profile.html">
</head>
<body>
  <a class="skip-link" href="#main-content">Skip to main content</a>
  <header class="site-header">
    <div class="container nav-row">
      <div class="brand">
        <a href="index.html" class="brand-link">
          <img src="logo.png" alt="AfgJobs Logo" class="site-logo" onerror="this.style.display='none'" loading="lazy" decoding="async" width="50" height="30">
          <div>
            <h1 class="site-title">AfgJobs</h1>
            <p class="site-tagline">Fast local jobs for Afghans</p>
          </div>
        </a>
      </div>
      <nav class="main-nav" aria-label="Primary Navigation">
        <a href="index.html" class="nav-link">Home</a>
        <a href="jobs.html" class="nav-link">Jobs</a>
        <a href="about.html" class="nav-link">About</a>
        <a href="contact.html" class="nav-link">Contact</a>
        <a href="post-job.html" class="nav-link cta">Post Job</a>
      </nav>
      <div class="nav-auth">
        <span id="user-display" style="color: var(--muted); font-size: 0.9rem; margin-right: 1rem; display: none;"></span>
        <a href="profile.html" id="profile-link" class="nav-link active" aria-current="page" style="color: var(--primary); display: none;">My Profile</a>
        <a href="settings.html" id="settings-link" class="nav-link" style="color: var(--primary); display: none;">Settings</a>
        <a href="auth.html" id="auth-link" class="nav-link" style="color: var(--primary);">Sign In</a>
        <button id="logout-btn" class="nav-link" style="background: none; border: none; cursor: pointer; color: #dc2626; display: none;">Logout</button>
      </div>
      <button id="themeToggle" class="theme-toggle" aria-label="Toggle Theme" aria-pressed="false">Toggle Theme</button>
    </div>
  </header>

  <main id="main-content" class="container">
    <section class="profile-header">
      <div class="profile-card">
        <div class="profile-avatar">
          <img id="avatar-image" class="profile-avatar-image" src="" alt="Profile picture" style="display:none;">
          <span id="avatar-initials">JS</span>
        </div>
        <div class="profile-info">
          <h2 id="profile-name">John Smith</h2>
          <p id="profile-type" class="profile-type">Freelancer</p>
          <p id="profile-email" class="profile-email">john@example.com</p>
          <p id="profile-contact" class="profile-contact">+93 700 123 456</p>
          <div class="profile-stats">
            <div class="stat">
              <span class="stat-number" id="stat-jobs">0</span>
              <span class="stat-label">Jobs Posted</span>
            </div>
            <div class="stat">
              <span class="stat-number" id="stat-active">0</span>
              <span class="stat-label">Active</span>
            </div>
            <div class="stat">
              <span class="stat-number" id="stat-completed">0</span>
              <span class="stat-label">Completed</span>
            </div>
          </div>
        </div>
        <button id="edit-profile-btn" class="btn">Edit Profile</button>
      </div>
    </section>

    <section class="profile-content">
      <div class="profile-tabs">
        <button class="profile-tab active" data-tab="my-jobs">My Jobs</button>
        <button class="profile-tab" data-tab="profile-info">Profile Info</button>
        <button class="profile-tab" data-tab="settings">Settings</button>
      </div>

      <div id="my-jobs" class="profile-tab-content active">
        <h3>My Job Postings</h3>
        <div id="jobs-list" class="jobs-list">
          <p class="empty-state">No jobs posted yet. <a href="post-job.html">Post your first job</a></p>
        </div>
      </div>

      <div id="profile-info" class="profile-tab-content">
        <h3>Profile Information</h3>
        <form id="profile-form" class="profile-form">
          <div class="form-row">
            <div class="form-col">
              <label for="edit-name"><span class="required">*</span>Full Name</label>
              <input type="text" id="edit-name" name="name" required maxlength="100">
            </div>
            <div class="form-col">
              <label for="edit-type"><span class="required">*</span>Account Type</label>
              <select id="edit-type" name="type" required>
                <option value="Freelancer">Freelancer</option>
                <option value="Company">Company</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-col">
              <label for="edit-email"><span class="required">*</span>Email</label>
              <input type="email" id="edit-email" name="email" required maxlength="100">
            </div>
            <div class="form-col">
              <label for="edit-contact"><span class="required">*</span>Phone/Contact</label>
              <input type="text" id="edit-contact" name="contact" required placeholder="+93 700 123 456" maxlength="50">
            </div>
          </div>

          <label for="edit-portfolio">Portfolio Link (optional)</label>
          <input type="url" id="edit-portfolio" name="portfolio" placeholder="https://instagram.com/username" maxlength="200">

          <label for="edit-bio">Bio (optional)</label>
          <textarea id="edit-bio" name="bio" rows="4" placeholder="Tell us about yourself, your skills, or your business..." maxlength="500"></textarea>
          <small class="char-count" id="bio-count">0/500</small>

          <label for="profile-photo">Profile Photo (optional)</label>
          <input type="file" id="profile-photo" accept="image/*">
          <small class="help-text">JPG/PNG/WebP up to 1.5MB</small>
          <div class="photo-actions">
            <button type="button" id="remove-photo-btn" class="btn outline small" style="display:none;">Remove Photo</button>
          </div>
          <small class="error" id="error-profilePhoto" aria-live="polite"></small>

          <div class="form-actions">
            <button type="submit" class="btn">Save Changes</button>
            <button type="button" id="cancel-edit" class="btn outline" style="display:none;">Cancel</button>
          </div>
          <p id="profile-msg" class="form-msg" aria-live="polite"></p>
        </form>
      </div>

      <div id="settings" class="profile-tab-content">
        <h3>Account Settings</h3>

        <div class="settings-section">
          <h4>Password</h4>
          <p>Change your account password</p>
          <form id="password-form" class="settings-form">
            <label for="current-password"><span class="required">*</span>Current Password</label>
            <input type="password" id="current-password" name="currentPassword" required>
            <small class="error" id="error-currentPassword" aria-live="polite"></small>

            <label for="new-password"><span class="required">*</span>New Password</label>
            <input type="password" id="new-password" name="newPassword" required minlength="6">
            <small class="help-text">At least 6 characters</small>
            <small class="error" id="error-newPassword" aria-live="polite"></small>

            <label for="confirm-password"><span class="required">*</span>Confirm Password</label>
            <input type="password" id="confirm-password" name="confirmPassword" required minlength="6">
            <small class="error" id="error-confirmPassword" aria-live="polite"></small>

            <button type="submit" class="btn">Update Password</button>
            <p id="password-msg" class="form-msg" aria-live="polite"></p>
          </form>
        </div>

        <div class="settings-section danger">
          <h4>Danger Zone</h4>
          <p>Delete your account and all associated data</p>
          <button id="delete-account-btn" class="btn danger">Delete Account</button>
          <p id="delete-msg" class="form-msg" aria-live="polite"></p>
        </div>
      </div>
    </section>
  </main>

  <div id="profile-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <button class="modal-close">&times;</button>
      <h3>Edit Your Profile</h3>
      <form id="quick-edit-form" class="profile-form">
        <label for="modal-name"><span class="required">*</span>Full Name</label>
        <input type="text" id="modal-name" name="name" required maxlength="100">

        <label for="modal-bio">Bio</label>
        <textarea id="modal-bio" name="bio" rows="4" maxlength="500" placeholder="Tell us about yourself..."></textarea>
        <small class="char-count" id="modal-bio-count">0/500</small>

        <div class="form-actions">
          <button type="submit" class="btn">Update Profile</button>
          <button type="button" class="modal-close btn outline">Cancel</button>
        </div>
        <p id="modal-msg" class="form-msg" aria-live="polite"></p>
      </form>
    </div>
  </div>

  <div id="delete-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <button class="modal-close">&times;</button>
      <h3>Delete Account</h3>
      <p>Are you sure? This cannot be undone. All your job postings and data will be permanently deleted.</p>
      <div class="form-actions">
        <button id="confirm-delete-btn" class="btn danger">Yes, Delete My Account</button>
        <button class="modal-close btn outline">Cancel</button>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-inner">
      <div class="footer-brand">AfgJobs</div>
      <div class="footer-tagline">Helping Afghans find local work</div>
      <div class="footer-links"><a href="faq.html">FAQ</a><span aria-hidden="true">|</span><a href="privacy.html">Privacy</a><span aria-hidden="true">|</span><a href="terms.html">Terms</a></div>
      <div class="footer-copyright">&copy; 2026 AfgJobs - Built for Afghanistan</div>
    </div>
  </footer>

  <script src="script.js" defer></script>
  <script>
    const KEYS = {
      USER: 'afg_current_user',
      USERS: 'afg_users',
      JOBS: 'afg_jobs_data'
    };

    let activeUser = null;

    document.addEventListener('DOMContentLoaded', function () {
      activeUser = readJson(KEYS.USER, null);
      if (!activeUser) {
        window.location.href = 'auth.html';
        return;
      }

      loadProfileData(activeUser);
      loadUserJobs(activeUser.id);
      setupTabNavigation();
      setupFormHandlers();
      setupModalHandlers();
      setupBioCounters();
    });

    function readJson(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      } catch {
        return fallback;
      }
    }

    function writeJson(key, value) {
      localStorage.setItem(key, JSON.stringify(value));
    }

    function syncUserToUsersCollection(user) {
      const users = readJson(KEYS.USERS, []);
      const index = users.findIndex((u) => u.id === user.id || u.email === user.email);

      if (index >= 0) {
        users[index] = {
          ...users[index],
          fullname: user.fullname,
          email: user.email,
          phone: user.phone,
          type: user.type,
          portfolio: user.portfolio,
          bio: user.bio,
          avatar: user.avatar || ''
        };
      }

      writeJson(KEYS.USERS, users);
    }

    function showMessage(elementId, text, type) {
      const el = document.getElementById(elementId);
      if (!el) return;
      el.textContent = text;
      el.className = `form-msg ${type}`;
      setTimeout(() => {
        el.textContent = '';
        el.className = 'form-msg';
      }, 3000);
    }

    function clearError(errorId) {
      const el = document.getElementById(errorId);
      if (!el) return;
      el.textContent = '';
      el.classList.remove('show');
    }

    function setError(errorId, text) {
      const el = document.getElementById(errorId);
      if (!el) return;
      el.textContent = text;
      el.classList.add('show');
    }

    function loadProfileData(user) {
      const displayName = user.fullname || 'User';

      document.getElementById('profile-name').textContent = displayName;
      document.getElementById('profile-type').textContent = user.type || 'User';
      document.getElementById('profile-email').textContent = user.email || '';
      document.getElementById('profile-contact').textContent = user.phone || '';
      renderAvatar(user.avatar, displayName);

      document.getElementById('edit-name').value = displayName;
      document.getElementById('edit-type').value = user.type || 'Freelancer';
      document.getElementById('edit-email').value = user.email || '';
      document.getElementById('edit-contact').value = user.phone || '';
      document.getElementById('edit-portfolio').value = user.portfolio || '';
      document.getElementById('edit-bio').value = user.bio || '';

      document.getElementById('modal-name').value = displayName;
      document.getElementById('modal-bio').value = user.bio || '';

      updateStats(user.id);
    }

    function renderAvatar(photoData, fullName) {
      const initials = document.getElementById('avatar-initials');
      const image = document.getElementById('avatar-image');
      const removeBtn = document.getElementById('remove-photo-btn');

      initials.textContent = getInitials(fullName || 'User');

      if (photoData) {
        image.src = photoData;
        image.style.display = 'block';
        initials.style.display = 'none';
        if (removeBtn) removeBtn.style.display = 'inline-flex';
      } else {
        image.removeAttribute('src');
        image.style.display = 'none';
        initials.style.display = 'inline';
        if (removeBtn) removeBtn.style.display = 'none';
      }
    }

    function getInitials(name) {
      if (!name) return 'U';
      return name.split(' ').map((n) => n[0]).join('').toUpperCase().slice(0, 2);
    }

    function getUserJobs(userId, userEmail) {
      const jobs = readJson(KEYS.JOBS, []);
      return jobs.filter((job) => job.posterId === userId || job.postedBy === userEmail);
    }

    function loadUserJobs(userId) {
      const userJobs = getUserJobs(userId, activeUser.email);
      const jobsList = document.getElementById('jobs-list');

      if (userJobs.length === 0) {
        jobsList.innerHTML = '<p class="empty-state">No jobs posted yet. <a href="post-job.html">Post your first job</a></p>';
        return;
      }

      jobsList.innerHTML = userJobs.map((job) => `
        <div class="job-card">
          <div class="job-header">
            <h4>${escapeHtml(job.title || 'Untitled')}</h4>
            <span class="job-status ${escapeHtml(job.status || 'active')}">${escapeHtml(job.status || 'Active')}</span>
          </div>
          <p class="job-excerpt">${escapeHtml((job.description || '').slice(0, 100))}${(job.description || '').length > 100 ? '...' : ''}</p>
          <div class="job-meta">
            <span>Location: ${escapeHtml(job.location || 'Remote')}</span>
            <span>Budget: ${escapeHtml(job.currency || 'USD')} ${escapeHtml(job.price ?? 'N/A')}</span>
            <span>Posted: ${formatDate(job.createdAt)}</span>
          </div>
          <div class="job-actions">
            <button class="btn small" onclick="editJob('${job.id}')">Edit</button>
            <button class="btn small outline" onclick="deleteJob('${job.id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function updateStats(userId) {
      const userJobs = getUserJobs(userId, activeUser.email);
      const activeJobs = userJobs.filter((job) => job.status !== 'closed').length;

      document.getElementById('stat-jobs').textContent = String(userJobs.length);
      document.getElementById('stat-active').textContent = String(activeJobs);
      document.getElementById('stat-completed').textContent = String(Math.max(0, userJobs.length - activeJobs));
    }

    function setupTabNavigation() {
      document.querySelectorAll('.profile-tab').forEach((tab) => {
        tab.addEventListener('click', function () {
          const tabName = this.dataset.tab;

          document.querySelectorAll('.profile-tab-content').forEach((content) => {
            content.classList.remove('active');
          });
          document.querySelectorAll('.profile-tab').forEach((t) => {
            t.classList.remove('active');
          });

          document.getElementById(tabName).classList.add('active');
          this.classList.add('active');
        });
      });
    }

    function setupFormHandlers() {
      document.getElementById('profile-photo').addEventListener('change', function (e) {
        clearError('error-profilePhoto');
        const file = e.target.files && e.target.files[0];
        if (!file) return;

        if (!file.type.startsWith('image/')) {
          setError('error-profilePhoto', 'Please choose an image file.');
          this.value = '';
          return;
        }

        if (file.size > 1.5 * 1024 * 1024) {
          setError('error-profilePhoto', 'Image must be 1.5MB or smaller.');
          this.value = '';
          return;
        }

        const reader = new FileReader();
        reader.onload = function (event) {
          activeUser.avatar = String(event.target?.result || '');
          renderAvatar(activeUser.avatar, activeUser.fullname || 'User');
        };
        reader.readAsDataURL(file);
      });

      document.getElementById('remove-photo-btn').addEventListener('click', function () {
        activeUser.avatar = '';
        document.getElementById('profile-photo').value = '';
        clearError('error-profilePhoto');
        renderAvatar('', activeUser.fullname || 'User');
      });

      document.getElementById('profile-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const updated = {
          ...activeUser,
          fullname: document.getElementById('edit-name').value.trim(),
          type: document.getElementById('edit-type').value,
          email: document.getElementById('edit-email').value.trim(),
          phone: document.getElementById('edit-contact').value.trim(),
          portfolio: document.getElementById('edit-portfolio').value.trim(),
          bio: document.getElementById('edit-bio').value.trim(),
          avatar: activeUser.avatar || ''
        };

        activeUser = updated;
        writeJson(KEYS.USER, updated);
        syncUserToUsersCollection(updated);
        loadProfileData(updated);
        showMessage('profile-msg', 'Profile updated successfully.', 'success');
      });

      document.getElementById('password-form').addEventListener('submit', function (e) {
        e.preventDefault();

        clearError('error-currentPassword');
        clearError('error-newPassword');
        clearError('error-confirmPassword');

        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;

        const users = readJson(KEYS.USERS, []);
        const userRecord = users.find((u) => u.id === activeUser.id || u.email === activeUser.email);

        if (!userRecord || userRecord.password !== currentPassword) {
          setError('error-currentPassword', 'Current password is incorrect.');
          return;
        }

        if (newPassword.length < 6) {
          setError('error-newPassword', 'Password must be at least 6 characters.');
          return;
        }

        if (newPassword !== confirmPassword) {
          setError('error-confirmPassword', 'Passwords do not match.');
          return;
        }

        userRecord.password = newPassword;
        writeJson(KEYS.USERS, users);
        showMessage('password-msg', 'Password updated successfully.', 'success');
        this.reset();
      });

      document.getElementById('delete-account-btn').addEventListener('click', function () {
        document.getElementById('delete-modal').style.display = 'block';
      });

      document.getElementById('confirm-delete-btn').addEventListener('click', function () {
        const users = readJson(KEYS.USERS, []).filter((u) => u.id !== activeUser.id && u.email !== activeUser.email);
        writeJson(KEYS.USERS, users);

        const jobs = readJson(KEYS.JOBS, []).filter((job) => job.posterId !== activeUser.id && job.postedBy !== activeUser.email);
        writeJson(KEYS.JOBS, jobs);

        localStorage.removeItem(KEYS.USER);
        alert('Account deleted. Redirecting to home.');
        window.location.href = 'index.html';
      });

      document.getElementById('edit-profile-btn').addEventListener('click', function () {
        document.getElementById('profile-modal').style.display = 'block';
      });

      document.getElementById('quick-edit-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const updated = {
          ...activeUser,
          fullname: document.getElementById('modal-name').value.trim(),
          bio: document.getElementById('modal-bio').value.trim(),
          avatar: activeUser.avatar || ''
        };

        activeUser = updated;
        writeJson(KEYS.USER, updated);
        syncUserToUsersCollection(updated);
        loadProfileData(updated);
        document.getElementById('profile-modal').style.display = 'none';
        showMessage('modal-msg', 'Profile updated successfully.', 'success');
      });
    }

    function setupModalHandlers() {
      document.querySelectorAll('.modal-close').forEach((btn) => {
        btn.addEventListener('click', function () {
          this.closest('.modal').style.display = 'none';
        });
      });
    }

    function setupBioCounters() {
      document.getElementById('edit-bio').addEventListener('input', function () {
        document.getElementById('bio-count').textContent = `${this.value.length}/500`;
      });

      document.getElementById('modal-bio').addEventListener('input', function () {
        document.getElementById('modal-bio-count').textContent = `${this.value.length}/500`;
      });
    }

    function formatDate(isoString) {
      if (!isoString) return 'N/A';
      const date = new Date(isoString);
      if (Number.isNaN(date.getTime())) return 'N/A';
      return date.toLocaleDateString();
    }

    function escapeHtml(value) {
      return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function editJob(jobId) {
      localStorage.setItem('editJobId', jobId);
      window.location.href = 'post-job.html';
    }

    function deleteJob(jobId) {
      if (!confirm('Are you sure you want to delete this job?')) return;

      const jobs = readJson(KEYS.JOBS, []);
      const updated = jobs.filter((job) => String(job.id) !== String(jobId));
      writeJson(KEYS.JOBS, updated);

      loadUserJobs(activeUser.id);
      updateStats(activeUser.id);
    }
  </script>
</body>
</html>



